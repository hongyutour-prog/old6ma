<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å…­åª½æœƒç®¡ç†ç³»çµ± V14 - å…¨é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <style>
        :root {
            --primary: #800000; --secondary: #daa520; --light: #fdfaf5;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9; --dark: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--light); color: var(--dark); display: flex; height: 100vh; }
        
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; border-right: 3px solid var(--secondary); position: relative; z-index: 100; }
        #sidebar h2 { font-size: 0.9rem; margin-bottom: 25px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; transition: 0.2s; display: flex; align-items: center; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--secondary); color: var(--primary); font-weight: bold; }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }

        #main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; line-height: 1.8; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fdf5f5; color: var(--primary); font-size: 0.85rem; font-weight: bold; }
        
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 5px; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #loading-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; justify-content:center; align-items:center; font-weight:bold; color:var(--primary); }
    </style>
</head>
<body class="admin-mode">
<div id="loading-overlay">â³ é›²ç«¯åŒæ­¥ä¸­...</div>
<div id="sidebar">
    <h2>è€å…­åª½æœƒç®¡ç†ç³»çµ± V14</h2>
    <div class="nav-item active" onclick="showPage('history')"><span class="nav-icon">ğŸ“œ</span> æœƒå²æ²¿é©</div>
    <div class="nav-item" onclick="showPage('dashboard')"><span class="nav-icon">ğŸ“Š</span> çµ„ç¹”é€²åº¦</div>
    <div class="nav-item" onclick="showPage('members')"><span class="nav-icon">ğŸ‘¥</span> å…¨æœƒåå†Š</div>
    <div class="nav-item admin-only" onclick="showPage('msg')"><span class="nav-icon">ğŸ“£</span> è¨Šæ¯ç¾¤ç™¼</div>
    <div class="nav-item admin-only" onclick="showPage('add')"><span class="nav-icon">â•</span> æˆå“¡ç™»è¨˜</div>
    <div class="nav-item admin-only" onclick="showPage('config')"><span class="nav-icon">âš™ï¸</span> å„è§’å‘½å</div>
    <div class="nav-item admin-only" onclick="showQRCode()"><span class="nav-icon">ğŸ“±</span> åˆ†äº«ç™»è¨˜ç¢¼</div>
    <div style="position:absolute; bottom: 20px; left: 15px; right: 15px;">
        <button onclick="toggleMode()" style="width:100%; padding:10px; color:var(--secondary); border:1px solid var(--secondary); background:none; cursor:pointer;">åˆ‡æ›è§€çœ‹æ¨¡å¼</button>
    </div>
</div>
<div id="main">
    <!-- History Page -->
    <div id="page-history">
        <header><h1>æœƒå²æ²¿é©</h1></header>
        <div class="card">
            <h2 style="color:var(--primary); margin-bottom:15px; text-align:center;">ã€è€å…­åª½æœƒæ²¿é©ã€‘</h2>
            <p>æœ¬æœƒä¹‹å‰µè¨­é›–ç¼ºä¹å®Œæ•´ä¹‹æ­·å²è³‡æ–™è€ƒæ“šï¼Œæœ¬æ–‡æ˜¯æ ¹æ“šæ­·ä¾†æœ‰é—œæª”æ¡ˆè³‡æ–™è¨˜éŒ„åŠåœ°æ–¹è€†è€å‰è¼©å£è¿°ï¼Œç¶œåˆè¨˜éŒ„è€Œå½¢æˆã€‚</p>
            <p style="margin-top:15px;">å°ç£å¯¶å³¶ç”±æ–¼å››é¢ç’°æµ·å³¶å±…ç¥ˆç›¼ï¼Œå°Šç¨±ã€æµ·ç¥ã€å¤©ä¸Šè–æ¯åº‡ä½‘è¬æ°‘ç”Ÿå‘½è²¡ç”¢ä¹‹å®‰å…¨ï¼Œä¸¦ç¥ˆæ±‚é¢¨èª¿é›¨é †ï¼Œåœ‹æ³°æ°‘å®‰ï¼Œè¬äº‹å¦‚æ„ï¼Œç´„æ–¼å…‰ç·’ 20 å¹´é–“ï¼ˆè¥¿å…ƒ 1894 å¹´ï¼‰ï¼Œç”±åœ°æ–¹æœ‰å¿—è€…æ—å‚æ‹±å…ˆç”Ÿè™Ÿå¬ï¼Œå‰µç«‹ã€å—ç‘¤å®®ã€Œå¤©ä¸Šè–æ¯è€å…­åª½æœƒã€ã€ã€‚ç¬¬ä¸€å±†åœŸåœ°ç®¡ç†äººç‚ºé™³å…æ­å…ˆç”Ÿã€‚</p>
            <p style="margin-top:10px;">æœ¬æœƒåˆæˆç«‹æ™‚åƒ…æœ‰è‘£äº‹ä¸€ã€äºŒååï¼Œæœƒå“¡ç™¾é¤˜åï¼Œæ¨é¸æ—å‚æ‹±å…ˆç”Ÿæ“”ä»»ç¬¬ä¸€ä»»ç¸½ç†ï¼Œæ—ç¥–è—©å…ˆç”Ÿç¹¼ä»»ç¬¬äºŒä»»ï¼Œè³´ç™¸æ—å…ˆç”Ÿç¹¼ä»»ç¬¬ä¸‰ä»»ã€‚ç›®å‰çµ„ç¹”ç¸®æ¸›ç‚º 11 å¤§è§’ 42 å°è§’ï¼Œæœƒå“¡æ•¸ç´„ 3200 å¤šåã€‚</p>
            <p style="margin-top:25px; text-align:right; font-weight:bold; color:var(--primary);">
                ç¤¾åœ˜æ³•äººå°ä¸­å¸‚å—ç‘¤å®®å¤©ä¸Šè–æ¯è€å…­åª½æœƒ<br>
                ç†äº‹é•·ï¼šç›§å®šåœ‹<br>
                å‰¯ç†äº‹é•·ï¼šæéŠ˜é‘«<br>
                ç¸½å¹¹äº‹ï¼šé»ƒéˆä¸ æ­éŒ„
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="page-dashboard" style="display:none;">
        <header><h1>ä½ˆå»ºç¸½è¦½</h1></header>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div class="card" style="border-left: 5px solid var(--secondary);"><h3>æ ¸å¿ƒé ˜å°å±¤</h3><div id="leader-info"></div></div>
            <div class="card" style="border-left: 5px solid var(--info);"><h3>ç›£äº‹æœƒ</h3><div id="sup-info"></div></div>
        </div>
        <div class="card">
            <h3>11 è§’é”æˆç‡</h3>
            <table><thead><tr><th>è§’ä½</th><th>ç†äº‹åé¡</th><th>è‘£äº‹é€²åº¦</th><th>ç‹€æ…‹</th></tr></thead><tbody id="kaku-list"></tbody></table>
        </div>
    </div>

    <!-- Members -->
    <div id="page-members" style="display:none;">
        <header><h1>å…¨æœƒåå†Š</h1><div><button class="btn-action" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button><input type="text" id="search-m" placeholder="æœå°‹å§“å..." oninput="render()"></div></header>
        <div class="card"><table><thead><tr><th>å§“å</th><th>èº«ä»½</th><th>è·å‹™</th><th>æ‰‹æ©Ÿ</th><th>æ­¸å±¬</th><th class="admin-only">ç®¡ç†</th></tr></thead><tbody id="member-table"></tbody></table></div>
    </div>

    <!-- Message -->
    <div id="page-msg" style="display:none;">
        <header><h1>ğŸ“£ è¨Šæ¯ä¸­å¿ƒ</h1></header>
        <div class="card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <select id="msg-role"><option value="all">å…¨é«”è·ç´š</option><option value="ç†äº‹">ç†äº‹</option><option value="è‘£äº‹">è‘£äº‹</option></select>
                <select id="msg-kaku"></select>
            </div>
            <textarea id="msg-body" rows="4" style="width:100%;" placeholder="è¼¸å…¥è¨Šæ¯å…§å®¹..."></textarea>
            <button class="btn-action" onclick="genMsg()" style="margin-top:15px;">ç”¢ç”ŸæŒ‡ä»¤</button>
            <div id="payload-area" style="display:none;"><div class="payload-box" id="payload-content"></div></div>
        </div>
    </div>

    <!-- Add Member -->
    <div id="page-add" style="display:none;">
        <header><h1>æˆå“¡ç™»è¨˜</h1></header>
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <form id="add-form">
                <div class="form-group"><label>å§“å</label><input type="text" id="in-name" required></div>
                <div class="form-group"><label>æ‰‹æ©Ÿ</label><input type="tel" id="in-phone" required></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><label>èº«ä»½</label><select id="in-base" onchange="uiAdd()"><option value="æœƒå“¡">æœƒå“¡</option><option value="è‘£äº‹">è‘£äº‹</option><option value="ç†äº‹">ç†äº‹</option></select></div>
                    <div class="form-group"><label>è·å‹™</label><select id="in-title"><option value="">--</option><option value="ç†äº‹é•·">ç†äº‹é•·</option><option value="å‰¯ç†äº‹é•·">å‰¯ç†äº‹é•·</option></select></div>
                </div>
                <div id="kaku-sect">
                    <div class="form-group"><label>å¤§è§’</label><select id="in-kaku" onchange="uiSK()"></select></div>
                    <div class="form-group" id="sk-wrap"><label>å°è§’</label><select id="in-skaku"></select></div>
                </div>
                <button type="submit" class="btn-action" style="width:100%">â˜ï¸ å­˜å…¥é›²ç«¯</button>
            </form>
        </div>
    </div>

    <!-- Config -->
    <div id="page-config" style="display:none;">
        <header><h1>è§’ä½å‘½åè¨­å®š</h1></header>
        <div id="cfg-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:15px;"></div>
        <button class="btn-action" onclick="saveCfg()" style="margin-top:20px; width:100%;">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥å‘½åè‡³é›²ç«¯</button>
    </div>
</div>
<div id="qr-overlay" onclick="this.style.display='none'"><div class="qr-card" onclick="event.stopPropagation()"><h3>ç™»è¨˜ç¢¼</h3><div id="qrcode" style="margin:20px auto; width:180px; height:180px;"></div></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzfLug-EeJk-lOxMtR0YwCPqO-FCppV3aqehychOjUsY4MbVzEVCIv62CPz1iFScX4/exec"; 

    let members = [];
    let config = {};
    let isAdmin = true;

    async function syncFromCloud() {
        if(!SCRIPT_URL.includes("http")) return;
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const resp = await fetch(SCRIPT_URL);
            const data = await resp.json();
            members = data.members || [];
            if(Object.keys(data.config).length > 0) config = data.config;
            render();
            updateConfigUI();
        } catch(e) { console.error("åŒæ­¥å¤±æ•—", e); }
        document.getElementById('loading-overlay').style.display = 'none';
    }

    function updateConfigUI() {
        const grid = document.getElementById('cfg-grid'); grid.innerHTML = '';
        for(let i=1; i<=11; i++) {
            if(!config[i]) config[i] = { name: `ç¬¬ ${i} è§’`, sk: {1:"1å°",2:"2å°",3:"3å°",4:"4å°"}, dQuota:1 };
            let skIn = ''; for(let j=1; j<=4; j++) skIn += `<input type="text" id="cs-${i}-${j}" value="${config[i].sk[j]}" style="margin-top:5px; font-size:0.8rem;">`;
            grid.innerHTML += `<div class="card"><label>å¤§è§’ ${i}</label><input type="text" id="cn-${i}" value="${config[i].name}">${skIn}</div>`;
        }
        const kSelect = document.getElementById('in-kaku'); const mkSelect = document.getElementById('msg-kaku');
        kSelect.innerHTML = ''; mkSelect.innerHTML = '<option value="all">å…¨æœƒ</option>';
        for(let i in config) { kSelect.innerHTML += `<option value="${i}">${config[i].name}</option>`; mkSelect.innerHTML += `<option value="${i}">${config[i].name}</option>`; }
    }

    async function saveCfg() {
        let newCfg = {};
        for(let i=1; i<=11; i++) {
            newCfg[i] = { name: document.getElementById('cn-'+i).value, sk: {
                1: document.getElementById(`cs-${i}-1`).value, 2: document.getElementById(`cs-${i}-2`).value,
                3: document.getElementById(`cs-${i}-3`).value, 4: document.getElementById(`cs-${i}-4`).value
            }, dQuota: 1 };
        }
        document.getElementById('loading-overlay').style.display = 'flex';
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: 'saveConfig', config: newCfg}) });
        alert('å‘½åå·²æˆåŠŸåŒæ­¥è‡³é›²ç«¯ï¼');
        await syncFromCloud();
    }

    function render() {
        const mList = document.getElementById('member-list'); const s = document.getElementById('search-m').value.toLowerCase();
        mList.innerHTML = '';
        members.filter(m => m.name.toLowerCase().includes(s)).forEach(m => {
            const loc = m.baseRole==='ç†äº‹' ? config[m.kaku].name : `${config[m.kaku].name}(${config[m.kaku].sk[m.skaku]})`;
            mList.innerHTML += `<tr><td>${m.name}</td><td>${m.baseRole}</td><td>${m.title||'--'}</td><td>${m.phone}</td><td>${loc}</td><td class="admin-only">--</td></tr>`;
        });
        document.getElementById('leader-info').innerHTML = `ç†äº‹é•·ï¼š${(members.find(m=>m.title==='ç†äº‹é•·')||{}).name||'--'}`;
    }

    document.getElementById('add-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = { action: 'add', name: document.getElementById('in-name').value, phone: document.getElementById('in-phone').value, baseRole: document.getElementById('in-base').value, title: document.getElementById('in-title').value, kaku: document.getElementById('in-kaku').value, skaku: document.getElementById('in-skaku').value };
        document.getElementById('loading-overlay').style.display = 'flex';
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        alert('æˆå“¡ç™»è¨˜æˆåŠŸï¼');
        this.reset();
        await syncFromCloud();
        showPage('members');
    };

    function showPage(p) {
        ["history","dashboard","members","add","config","msg"].forEach(id => { document.getElementById('page-'+id).style.display='none'; });
        document.getElementById('page-'+p).style.display='block';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        render();
    }

    function showQRCode() {
        const container = document.getElementById('qrcode'); container.innerHTML = '';
        new QRCode(container, { text: window.location.href.split('?')[0] + "?page=add", width: 180, height: 180 });
        document.getElementById('qr-overlay').style.display='flex';
    }

    function uiAdd() { document.getElementById('sk-wrap').style.display = (document.getElementById('in-base').value==='ç†äº‹') ? 'none' : 'block'; }
    function uiSK() { /* é‚è¼¯å·²æ•´åˆåœ¨updateConfigUI */ }
    function toggleMode() { isAdmin = !isAdmin; document.body.className = isAdmin ? 'admin-mode' : 'readonly-mode'; showPage('dashboard'); }

    window.onload = () => { syncFromCloud(); if(new URLSearchParams(window.location.search).get('page')==='add') showPage('add'); };
</script>
</body>
</html>
