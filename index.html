<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è€å…­åª½æœƒç®¡ç†ç³»çµ± V17.6</title>
    <style>
        :root {
            --primary: #800000; --secondary: #daa520; --light: #fdfaf5;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9; --dark: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--light); color: var(--dark); display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„èˆ‡å°è¦½ */
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; border-right: 3px solid var(--secondary); overflow-y: auto; transition: 0.3s; }
        #sidebar h2 { font-size: 0.95rem; margin-bottom: 25px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .nav-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; font-size: 1rem; color: #eee; transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--secondary); color: var(--primary); font-weight: bold; }

        #main { flex-grow: 1; padding: 30px; overflow-y: auto; width: 100%; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); font-size: 1.3rem; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-action { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1rem; width: 100%; cursor: pointer; transition: 0.3s; }
        .btn-action:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-line { background: #06C755; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 15px; }

        #mobile-menu-btn { 
            display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; 
            background: var(--primary); color: var(--secondary); border: 2px solid var(--secondary);
            padding: 8px 15px; border-radius: 8px; font-weight: bold;
        }

        /* ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD */
        @media (max-width: 800px) {
            body { flex-direction: column; }
            #mobile-menu-btn { display: block; }
            #sidebar { position: fixed; left: -260px; top: 0; height: 100%; z-index: 1000; width: 260px; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
            #sidebar.open { left: 0; }
            #main { padding: 70px 15px 15px 15px; }
            header h1 { font-size: 1.1rem; }
        }

        /* ğŸ–¨ï¸ åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            #sidebar, #mobile-menu-btn, #menu-overlay, header, .admin-only, #sync-status, .btn-action, input[type="text"] { 
                display: none !important; 
            }
            #main { padding: 0 !important; margin: 0 !important; width: 100% !important; overflow: visible !important; }
            body { background: white !important; overflow: visible !important; }
            .card { box-shadow: none !important; border: 1px solid #eee !important; padding: 0 !important; }
            table { font-size: 10pt !important; border: 1px solid #000; width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000 !important; padding: 8px !important; color: black !important; }
            h1 { text-align: center; margin-bottom: 20px; display: block !important; color: black; }
        }

        #qr-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1100; padding: 20px; }
        .qr-card { background: white; padding: 30px; border-radius: 20px; text-align: center; border: 5px solid var(--secondary); width: 100%; max-width: 350px; }
        #sync-status { position: fixed; bottom: 5px; right: 5px; font-size: 0.6rem; color: #ccc; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
        
        .readonly-mode .admin-only { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fdf5f5; color: var(--primary); font-size: 0.85rem; padding: 12px 10px; text-align: left; border-bottom: 2px solid var(--primary); }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body class="admin-mode">

<button id="mobile-menu-btn" onclick="toggleSidebar()">â˜° é¸å–®</button>
<div id="menu-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
    <h2 style="margin-top:20px;">è€å…­åª½æœƒç®¡ç†ç³»çµ± V17.6</h2>
    <div class="nav-item active" onclick="navTo('history')">ğŸ“œ æœƒå²æ²¿é©</div>
    <div class="nav-item" onclick="navTo('dashboard')">ğŸ“Š çµ„ç¹”ä½ˆå»ºç¸½è¦½</div>
    <div class="nav-item" onclick="navTo('members')">ğŸ‘¥ å…¨æœƒåå†Š</div>
    <div class="nav-item admin-only" onclick="navTo('add')">â• æˆå“¡ç™»è¨˜æˆè·</div>
    <div class="nav-item admin-only" onclick="navTo('config')">âš™ï¸ é›²ç«¯æ¶æ§‹è¨­å®š</div>
    <div class="nav-item admin-only" onclick="showQRCode()">ğŸ“± åˆ†äº«ç™»è¨˜ç¢¼</div>
    <div style="position: absolute; bottom: 20px; left: 15px; right: 15px;">
        <button id="mode-btn" onclick="toggleMode()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--secondary); background:none; color:var(--secondary); font-size:0.8rem; font-weight:bold;">ğŸ”“ ç®¡ç†å“¡æ¨¡å¼</button>
    </div>
</div>

<div id="main">
    <!-- æœƒå²æ²¿é© -->
    <div id="page-history">
        <header><h1>æœƒå²æ²¿é©</h1> <button class="btn-action admin-only" onclick="editHistory()" style="width:auto; padding:8px 15px;">ğŸ“ ç·¨è¼¯</button></header>
        <div class="card" id="history-display">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:15px;">ã€è€å…­åª½æœƒæ²¿é©ã€‘</h2>
            <div id="history-text" style="line-height:1.8; white-space: pre-wrap;">è¼‰å…¥ä¸­...</div>
            <p style="margin-top:30px; text-align:right; font-weight:bold; color:var(--primary); line-height:1.5;">ç†äº‹é•·ï¼šç›§å®šåœ‹<br>å‰¯ç†äº‹é•·ï¼šæéŠ˜é‘«<br>ç¸½å¹¹äº‹ï¼šé»ƒéˆä¸ã€€æ­éŒ„</p>
        </div>
    </div>

    <!-- çµ„ç¹”ä½ˆå»º -->
    <div id="page-dashboard" style="display:none;">
        <header><h1>ä½ˆå»ºé€²åº¦ç¸½è¦½</h1></header>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="card" style="border-left: 5px solid var(--secondary);">
                <h3>æ ¸å¿ƒé ˜å°å±¤</h3>
                <div id="leader-info" style="margin-top:10px; line-height:2;"></div>
            </div>
            <div class="card" style="border-left: 5px solid var(--info);">
                <h3>ç›£äº‹æœƒ (ç›®æ¨™ 3 å“¡)</h3>
                <div id="sup-info" style="margin-top:10px; line-height:2;"></div>
            </div>
        </div>
        <div class="card">
            <h3>11 è§’çµ„ç¹”é”æˆç‡</h3>
            <div style="overflow-x: auto; margin-top:15px;">
                <table>
                    <thead><tr><th>è§’ä½åç¨±</th><th>ç†äº‹</th><th>è‘£äº‹é€²åº¦</th></tr></thead>
                    <tbody id="kaku-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å…¨æœƒåå†Š (ä¿®å¾©é‡é») -->
    <div id="page-members" style="display:none;">
        <header>
            <h1>å…¨æœƒæˆå“¡åå†Š</h1>
            <button class="btn-action" onclick="window.print()" style="width:auto; padding:8px 15px; background:var(--info); font-size:0.9rem;">ğŸ–¨ï¸ åˆ—å°åå†Š</button>
        </header>
        <div style="margin-bottom:15px;">
            <input type="text" id="search-m" placeholder="ğŸ” æœå°‹å§“åã€æ‰‹æ©Ÿã€è·å‹™æˆ–è§’ä½..." oninput="render()" style="padding:12px; border:2px solid var(--primary); border-radius:10px;">
        </div>
        <div class="card" style="padding:5px; overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>å§“å / æ‰‹æ©Ÿ</th>
                        <th>æ­¸å±¬ä½ç½®</th>
                        <th>èº«ä»½è·å‹™</th>
                        <th class="admin-only" style="text-align:right;">ç®¡ç†</th>
                    </tr>
                </thead>
                <tbody id="member-table"></tbody>
            </table>
        </div>
    </div>

    <!-- æˆå“¡ç™»è¨˜ (æ–°å¢ LINE æŒ‰éˆ•) -->
    <div id="page-add" style="display:none;">
        <header><h1>æˆå“¡ç™»è¨˜æˆè·</h1></header>
        <div id="add-success-screen" style="display:none; text-align:center; padding:20px;">
            <div style="font-size: 5rem;">âœ…</div>
            <h2 style="margin:10px 0; color:var(--success);">ç™»è¨˜å®Œæˆ</h2>
            <p style="margin-bottom:20px; color:#666;">è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯è³‡æ–™åº«</p>
            
            <div class="card" style="background:#f0fff4; border:1px solid #c6f6d5;">
                <h3>ğŸ“¢ é‡è¦ä¸‹ä¸€æ­¥</h3>
                <p style="margin:10px 0; font-size:0.95rem;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥ã€Œè€å…­åª½æœƒå®˜æ–¹ LINEã€<br>å³å¯éš¨æ™‚æŸ¥è©¢æœƒå‹™èˆ‡ AI è«®è©¢</p>
                <a href="https://line.me/R/ti/p/@YOUR_LINE_ID" class="btn-line">ğŸŸ¢ åŠ å…¥å®˜æ–¹ LINE å¸³è™Ÿ</a>
            </div>

            <button class="btn-action" onclick="resetForm()" style="margin-top:20px; background:#666;">ç¹¼çºŒç™»è¨˜ä¸‹ä¸€ä½</button>
        </div>
        
        <div id="add-form-container" class="card">
            <form id="add-form">
                <div class="form-group"><label>å§“å</label><input type="text" id="in-name" placeholder="è«‹è¼¸å…¥å§“å" required></div>
                <div class="form-group"><label>æ‰‹æ©Ÿ</label><input type="tel" id="in-phone" placeholder="ä¾‹å¦‚ï¼š0912345678" required></div>
                <div class="form-group">
                    <label>èº«ä»½</label>
                    <select id="in-base" onchange="uiAdd()">
                        <option value="æœƒå“¡">æœƒå“¡</option>
                        <option value="çµ„é•·">çµ„é•·</option>
                        <option value="è‘£äº‹">è‘£äº‹</option>
                        <option value="ç†äº‹">ç†äº‹</option>
                        <option value="ç›£äº‹">ç›£äº‹</option>
                    </select>
                </div>
                <div id="kaku-sect">
                    <div class="form-group"><label>æ­¸å±¬å¤§è§’</label><select id="in-kaku" onchange="uiSK()"></select></div>
                    <div class="form-group" id="sk-wrap"><label>æ­¸å±¬å°è§’</label><select id="in-skaku"></select></div>
                </div>
                <div class="form-group">
                    <label>å…¼ä»»è·å‹™ (é¸å¡«)</label>
                    <select id="in-title">
                        <option value="">-- ç„¡ --</option>
                        <option value="ç†äº‹é•·">ç†äº‹é•·</option>
                        <option value="å‰¯ç†äº‹é•·">å‰¯ç†äº‹é•·</option>
                        <option value="å¸¸å‹™ç›£äº‹">å¸¸å‹™ç›£äº‹</option>
                        <option value="ç¸½å¹¹äº‹">ç¸½å¹¹äº‹</option>
                        <option value="æœƒè¨ˆ">æœƒè¨ˆ</option>
                        <option value="ç§˜æ›¸">ç§˜æ›¸</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="btn-action">âœ… ç¢ºèªå„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
            </form>
        </div>
    </div>

    <!-- é›²ç«¯æ¶æ§‹è¨­å®š -->
    <div id="page-config" style="display:none;">
        <header><h1>é›²ç«¯æ¶æ§‹è¨­å®š</h1></header>
        <p style="margin-bottom:15px; color:var(--danger); font-size:0.85rem;">â€» ä¿®æ”¹æ­¤è™•å°‡å³æ™‚æ›´æ–°å…¨æœƒçš„çµ„ç¹”çµæ§‹èˆ‡å‘½åã€‚</p>
        <div id="cfg-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:15px;"></div>
        <button class="btn-action" onclick="saveCfg()" style="margin-top:20px; background:var(--success);">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
</div>

<div id="qr-overlay" onclick="this.style.display='none'">
    <div class="qr-card" onclick="event.stopPropagation()">
        <h3 style="color:var(--primary); margin-bottom:15px;">è€å…­åª½æœƒç™»è¨˜ç¢¼</h3>
        <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
        <p style="font-size:0.9rem; color:#666;">è®“æœƒå“¡æƒæé€²è¡Œå¿«é€Ÿç™»è¨˜</p>
        <button class="btn-action" style="margin-top:15px; padding:10px; background:#666;" onclick="document.getElementById('qr-overlay').style.display='none'">é—œé–‰</button>
    </div>
</div>

<div id="sync-status">é›²ç«¯ï¼šå°±ç·’</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    // è«‹ç¢ºèªæ­¤ URL èˆ‡ä½ çš„ Google Apps Script ä½ˆç½²ç¶²å€ä¸€è‡´
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzfLug-EeJk-lOxMtR0YwCPqO-FCppV3aqehychOjUsY4MbVzEVCIv62CPz1iFScX4/exec";
    
    let members = []; 
    let config = {}; 
    let historyContent = ""; 
    let isAdmin = true;

    // é è¨­æ¶æ§‹è³‡æ–™
    const kPresets = { 1:{sk:2,d:1}, 2:{sk:5,d:2}, 3:{sk:4,d:1}, 4:{sk:2,d:1}, 5:{sk:3,d:1}, 6:{sk:3,d:1}, 7:{sk:3,d:1}, 8:{sk:3,d:1}, 9:{sk:2,d:1}, 10:{sk:3,d:1}, 11:{sk:3,d:1} };

    // åˆå§‹åŒ–èˆ‡åŒæ­¥
    async function syncFromCloud() {
        const status = document.getElementById('sync-status');
        status.textContent = "â˜ï¸ åŒæ­¥ä¸­...";
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            
            if(data.config) config = typeof data.config === 'string' ? JSON.parse(data.config) : data.config;
            if(data.members) members = typeof data.members === 'string' ? JSON.parse(data.members) : data.members;
            if(data.history) historyContent = data.history;

            // è‹¥é›²ç«¯ç„¡è³‡æ–™ï¼Œåˆå§‹åŒ–é è¨­å€¼
            if (!config || Object.keys(config).length === 0) {
                config = {};
                for(let i=1; i<=11; i++) {
                    let skMap = {}; for(let j=1; j<=kPresets[i].sk; j++) skMap[j] = `${j}å°è§’`;
                    config[i] = { name: `ç¬¬ ${i} è§’`, skCount: kPresets[i].sk, dQuota: kPresets[i].d, sk: skMap };
                }
            }
            
            buildConfigUI();
            initSelectors();
            render();
            status.textContent = "âœ… åŒæ­¥å®Œæˆ";
        } catch (e) {
            console.error(e);
            status.textContent = "âŒ é€£ç·šå¤±æ•— (ä½¿ç”¨å¿«å–)";
            render();
        }
    }

    function initSelectors() {
        const kSelect = document.getElementById('in-kaku');
        if(kSelect) {
            kSelect.innerHTML = '';
            for(let i in config) kSelect.innerHTML += `<option value="${i}">${config[i].name}</option>`;
            uiAdd();
        }
    }

    function buildConfigUI() {
        const grid = document.getElementById('cfg-grid');
        if(!grid) return;
        grid.innerHTML = '';
        for(let i in config) {
            let sks = '';
            for(let j=1; j<=config[i].skCount; j++) {
                sks += `<input type="text" id="cs-${i}-${j}" value="${config[i].sk[j]||j+'å°è§’'}" style="margin-top:5px; font-size:0.8rem; padding:8px;">`;
            }
            grid.innerHTML += `
                <div class="card" style="border-top:4px solid var(--secondary)">
                    <label>å¤§è§’ ${i} åç¨±</label>
                    <input type="text" id="cn-${i}" value="${config[i].name}">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        <div><label>å°è§’æ•¸</label><input type="number" id="cc-${i}" value="${config[i].skCount}" min="1"></div>
                        <div><label>ç†äº‹é¡</label><input type="number" id="cq-${i}" value="${config[i].dQuota}" min="1"></div>
                    </div>
                    <div style="margin-top:10px; background:#f9f9f9; padding:10px; border-radius:5px;">
                        <label>å°è§’å‘½åï¼š</label>
                        ${sks}
                    </div>
                </div>`;
        }
    }

    function uiAdd() {
        const r = document.getElementById('in-base').value;
        document.getElementById('kaku-sect').style.display = (r === 'ç›£äº‹') ? 'none' : 'block';
        document.getElementById('sk-wrap').style.display = (r === 'ç†äº‹' || r === 'ç›£äº‹') ? 'none' : 'block';
        uiSK();
    }

    function uiSK() {
        const s = document.getElementById('in-skaku');
        const k = document.getElementById('in-kaku').value;
        if(!config[k] || !s) return;
        s.innerHTML = '';
        for(let j in config[k].sk) s.innerHTML += `<option value="${j}">${config[k].sk[j]}</option>`;
    }

    function navTo(p) {
        document.querySelectorAll('#main > div').forEach(d => d.style.display='none');
        document.getElementById('page-'+p).style.display='block';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        
        const navItems = document.querySelectorAll('.nav-item');
        if(p === 'history') navItems[0].classList.add('active');
        if(p === 'dashboard') navItems[1].classList.add('active');
        if(p === 'members') { navItems[2].classList.add('active'); render(); }
        if(p === 'add') navItems[3].classList.add('active');
        if(p === 'config') navItems[4].classList.add('active');

        if(window.innerWidth <= 800) toggleSidebar();
    }

    function render() {
        document.getElementById('history-text').innerText = historyContent || "æœƒå²è¼‰å…¥ä¸­...";
        
        // Dashboard
        const chair = members.find(m => m.title === 'ç†äº‹é•·') || {name: '--'};
        const vChair = members.find(m => m.title === 'å‰¯ç†äº‹é•·') || {name: '--'};
        const lInfo = document.getElementById('leader-info');
        if(lInfo) lInfo.innerHTML = `ç†äº‹é•·ï¼š${chair.name}<br>å‰¯ç†äº‹é•·ï¼š${vChair.name}`;
        
        const sups = members.filter(m => m.baseRole === 'ç›£äº‹');
        const cSup = members.find(m => m.title === 'å¸¸å‹™ç›£äº‹') || {name: '--'};
        const sInfo = document.getElementById('sup-info');
        if(sInfo) sInfo.innerHTML = `ç›£äº‹æ•¸ï¼š${sups.length} / 3 å“¡<br>å¸¸å‹™ç›£äº‹ï¼š${cSup.name}`;

        const kBody = document.getElementById('kaku-list');
        if(kBody) {
            kBody.innerHTML = '';
            for(let i in config) {
                const dCount = members.filter(m => m.kaku == i && m.baseRole === 'ç†äº‹').length;
                const bCount = members.filter(m => m.kaku == i && m.baseRole === 'è‘£äº‹').length;
                kBody.innerHTML += `<tr><td>${config[i].name}</td><td>${dCount}/${config[i].dQuota}</td><td>${bCount}/${config[i].skCount}</td></tr>`;
            }
        }

        // Member Table
        const mBody = document.getElementById('member-table');
        if(!mBody) return;
        const sTerm = document.getElementById('search-m').value.toLowerCase();
        mBody.innerHTML = '';
        
        members.filter(m => 
            m.name.toLowerCase().includes(sTerm) || 
            m.phone.includes(sTerm) || 
            (m.title && m.title.toLowerCase().includes(sTerm)) ||
            (config[m.kaku] && config[m.kaku].name.includes(sTerm))
        ).forEach(m => {
            let loc = "";
            if(m.baseRole === 'ç›£äº‹') loc = "ç›£äº‹æœƒ";
            else if(config[m.kaku]) {
                loc = config[m.kaku].name;
                if(m.baseRole !== 'ç†äº‹' && m.skaku && config[m.kaku].sk[m.skaku]) loc += ` (${config[m.kaku].sk[m.skaku]})`;
            }

            mBody.innerHTML += `
                <tr>
                    <td><strong>${m.name}</strong><br><small style="color:#666">${m.phone}</small></td>
                    <td>${loc}</td>
                    <td><span style="background:var(--secondary); color:var(--primary); padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:bold;">${m.baseRole}</span><br>${m.title || ''}</td>
                    <td class="admin-only" style="text-align:right;"><button onclick="delM(${m.id})" style="color:var(--danger); border:none; background:none; cursor:pointer; font-weight:bold;">åˆªé™¤</button></td>
                </tr>`;
        });
    }

    document.getElementById('add-form').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.textContent = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
        
        const newMember = {
            id: Date.now(),
            name: document.getElementById('in-name').value,
            phone: document.getElementById('in-phone').value,
            baseRole: document.getElementById('in-base').value,
            title: document.getElementById('in-title').value,
            kaku: document.getElementById('in-kaku').value,
            skaku: document.getElementById('in-skaku').value
        };

        members.push(newMember);
        await saveToCloud();
        
        document.getElementById('add-form-container').style.display = 'none';
        document.getElementById('add-success-screen').style.display = 'block';
    };

    function resetForm() {
        document.getElementById('add-form').reset();
        document.getElementById('add-form-container').style.display = 'block';
        document.getElementById('add-success-screen').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').textContent = "âœ… ç¢ºèªå„²å­˜ä¸¦åŒæ­¥é›²ç«¯";
        uiAdd();
    }

   async function saveToCloud() {
    const status = document.getElementById('sync-status');
    status.textContent = "â³ åŒæ­¥ä¸­...";
    
    // æº–å‚™è¦å­˜å…¥çš„è³‡æ–™
    const dataToSave = {
        action: 'save',
        members: JSON.stringify(members),
        config: JSON.stringify(config),
        history: historyContent
    };

    // å„ªå…ˆä½¿ç”¨ GAS å…§å»ºçš„ google.script.run (é€™æ˜¯æœ€ç©©å®šçš„æ–¹å¼)
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler(() => { status.textContent = "âœ… é›²ç«¯å·²æ›´æ–°"; })
            .withFailureHandler((err) => { alert("åŒæ­¥å¤±æ•—ï¼š" + err); })
            .processData(dataToSave); // å‘¼å« GAS å¾Œç«¯çš„å‡½å¼
    } else {
        // å¦‚æœæ˜¯å¤–éƒ¨æ¸¬è©¦ç’°å¢ƒï¼Œä½¿ç”¨ fetch (éœ€è™•ç† CORS)
        try {
            // æ³¨æ„ï¼šGAS çš„ POST å¿…é ˆå°‡å…§å®¹è½‰ç‚ºå­—ä¸²å‚³é€
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(dataToSave)
            });
            status.textContent = "âœ… å·²åŒæ­¥é›²ç«¯";
        } catch(e) {
            status.textContent = "âŒ åŒæ­¥å¤±æ•—";
            console.error(e);
        }
    }
}

    async function delM(id) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½æˆå“¡å—ï¼Ÿ')) return;
        members = members.filter(m => m.id !== id);
        render();
        await saveToCloud();
    }

    async function saveCfg() {
        for(let i in config) {
            config[i].name = document.getElementById('cn-'+i).value;
            config[i].skCount = parseInt(document.getElementById('cc-'+i).value);
            config[i].dQuota = parseInt(document.getElementById('cq-'+i).value);
            let newSk = {};
            for(let j=1; j<=config[i].skCount; j++) {
                const el = document.getElementById(`cs-${i}-${j}`);
                newSk[j] = el ? el.value : `${j}å°è§’`;
            }
            config[i].sk = newSk;
        }
        await saveToCloud();
        alert('çµ„ç¹”æ¶æ§‹å·²æ›´æ–°ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼');
        syncFromCloud();
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('menu-overlay').style.display = 
            document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
    }

    function toggleMode() {
        isAdmin = !isAdmin;
        document.body.classList.toggle('readonly-mode', !isAdmin);
        document.getElementById('mode-btn').textContent = isAdmin ? "ğŸ”“ ç®¡ç†å“¡æ¨¡å¼" : "ğŸ”’ å”¯è®€æ¨¡å¼";
        document.getElementById('mode-btn').style.color = isAdmin ? "var(--secondary)" : "#ccc";
    }

    function showQRCode() {
        const container = document.getElementById('qrcode');
        container.innerHTML = '';
        new QRCode(container, { text: window.location.href.split('?')[0], width: 200, height: 200 });
        document.getElementById('qr-overlay').style.display = 'flex';
    }

    // å•Ÿå‹•åŒæ­¥
    window.onload = syncFromCloud;
</script>
</body>
</html>

