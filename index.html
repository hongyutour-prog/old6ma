<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å…­åª½æœƒç®¡ç†ç³»çµ± V6 - é¸æ‹”è³‡æ ¼æª¢æŸ¥ç‰ˆ</title>
    <style>
        :root {
            --primary: #800000; --secondary: #daa520; --light: #fdfaf5;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9; --dark: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--light); color: var(--dark); display: flex; height: 100vh; }
        
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; border-right: 3px solid var(--secondary); position: relative; }
        #sidebar h2 { font-size: 1rem; margin-bottom: 25px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; transition: 0.2s; display: flex; align-items: center; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--secondary); color: var(--primary); font-weight: bold; }
        .nav-icon { margin-right: 12px; }

        #main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); font-size: 1.4rem; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fdf5f5; color: var(--primary); font-size: 0.85rem; font-weight: bold; }
        
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 5px; display: inline-block; }
        .role-identity { background: #8e44ad; } /* ç†äº‹/è‘£äº‹ç­‰èº«ä»½ */
        .role-title { background: var(--secondary); color: var(--primary); border: 1px solid var(--primary); } /* ç†äº‹é•·ç­‰è·å‹™ */
        
        .progress-box { margin-top: 5px; }
        .progress-bg { width: 100%; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: 0.5s; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        #qr-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        .qr-card { background:white; padding:30px; border-radius:15px; text-align:center; box-shadow: 0 0 30px var(--secondary); }

        .readonly-mode .admin-only { display: none !important; }
        @media (max-width: 768px) { #sidebar { display: none; } #main { padding: 15px; } }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>è€å…­åª½æœƒç®¡ç† V6</h2>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">âš–ï¸</span> æ¬ŠåŠ›æ¶æ§‹ç¸½è¦½</div>
    <div class="nav-item" onclick="showPage('members')"><span class="nav-icon">ğŸ‘¥</span> å…¨æœƒæˆå“¡åå†Š</div>
    <div class="nav-item admin-only" onclick="showPage('add')"><span class="nav-icon">â•</span> æˆå“¡æˆè·ç™»è¨˜</div>
    <div class="nav-item admin-only" onclick="showPage('config')"><span class="nav-icon">âš™ï¸</span> è§’ä½è‡ªå®šç¾©</div>
    <div class="nav-item admin-only" onclick="showQRCode()"><span class="nav-icon">ğŸ“±</span> åˆ†äº«ç™»è¨˜ç¢¼</div>
    
    <div style="position:absolute; bottom: 20px; left: 15px; right: 15px;">
        <button id="toggle-mode" onclick="toggleMode()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--secondary); background:none; color:var(--secondary); cursor:pointer; font-weight:bold;">ğŸ”“ åˆ‡æ›è‡³å”¯è®€æ¨¡å¼</button>
    </div>
</div>

<div id="main">
    <!-- Dashboard Page -->
    <div id="page-dashboard">
        <header><h1>æ±ºç­–å±¤èˆ‡çµ„ç¹”ä½ˆå»ºç‹€æ³</h1></header>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div class="card" style="border-left: 5px solid var(--secondary);">
                <h3>æ ¸å¿ƒé ˜å°å±¤</h3>
                <div id="core-stats" style="margin-top:15px;"></div>
            </div>
            <div class="card" style="border-left: 5px solid var(--info);">
                <h3>ç›£äº‹æœƒ (3å“¡)</h3>
                <div id="sup-stats" style="margin-top:15px;"></div>
            </div>
        </div>

        <div class="card">
            <h3>11 è§’çµ„ç¹”ä½ˆå»ºç‡</h3>
            <table style="margin-top:15px;">
                <thead>
                    <tr><th>è§’ä½åç¨±</th><th>æ´¾é§ç†äº‹ (1)</th><th>æ´¾é§è‘£äº‹ (ä¾å°è§’æ•¸)</th><th>ä½ˆå»ºé€²åº¦</th></tr>
                </thead>
                <tbody id="kaku-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Member List -->
    <div id="page-members" style="display:none;">
        <header>
            <h1>å…¨æœƒæˆå“¡åå†Š</h1>
            <input type="text" id="search-m" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€è·å‹™..." oninput="render()" style="width:250px;">
        </header>
        <div class="card">
            <table>
                <thead><tr><th>å§“å</th><th>æœƒå…§èº«ä»½</th><th>å…¼ä»»è·å‹™</th><th>æ­¸å±¬è§’ä½ / å°è§’</th><th class="admin-only">ç®¡ç†</th></tr></thead>
                <tbody id="member-table"></tbody>
            </table>
        </div>
    </div>

    <!-- Add Form -->
    <div id="page-add" style="display:none;">
        <header><h1>æˆå“¡ç™»è¨˜èˆ‡æˆè·</h1></header>
        <div class="card" style="max-width: 550px; margin: 0 auto;">
            <form id="add-form">
                <div class="form-group"><label>å§“å</label><input type="text" id="m-name" required></div>
                <div class="form-group"><label>æ‰‹æ©Ÿ</label><input type="tel" id="m-phone" required></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>æœƒå…§èº«ä»½ (åº•ç¼º)</label>
                        <select id="m-base" onchange="handleRoleUI()" required>
                            <option value="æœƒå“¡">æœƒå“¡</option>
                            <option value="çµ„é•·">çµ„é•·</option>
                            <option value="è‘£äº‹">è‘£äº‹</option>
                            <option value="ç†äº‹">ç†äº‹</option>
                            <option value="ç›£äº‹">ç›£äº‹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å…¼ä»»è·å‹™ (é¸ä»»/è˜ä»»)</label>
                        <select id="m-title" onchange="validateQualifications()">
                            <option value="">-- ç„¡ --</option>
                            <option value="ç†äº‹é•·">ç†äº‹é•· (éœ€ç†äº‹èº«åˆ†)</option>
                            <option value="å‰¯ç†äº‹é•·">å‰¯ç†äº‹é•· (éœ€ç†äº‹èº«åˆ†)</option>
                            <option value="å¸¸å‹™ç›£äº‹">å¸¸å‹™ç›£äº‹ (éœ€ç›£äº‹èº«åˆ†)</option>
                            <option value="ç¸½å¹¹äº‹">ç¸½å¹¹äº‹</option>
                            <option value="ç§˜æ›¸">ç§˜æ›¸</option>
                            <option value="æœƒè¨ˆ">æœƒè¨ˆ</option>
                            <option value="å¹¹äº‹">å¹¹äº‹</option>
                        </select>
                    </div>
                </div>

                <div id="loc-group">
                    <div class="form-group"><label>æ­¸å±¬å¤§è§’</label><select id="m-kaku" onchange="updateSK()"></select></div>
                    <div class="form-group" id="sk-wrap"><label>æ­¸å±¬å°è§’</label><select id="m-skaku"></select></div>
                </div>

                <p id="error-tip" style="color:var(--danger); font-size:0.85rem; margin-bottom:15px; display:none;"></p>
                <button type="submit" class="btn-save" style="background:var(--primary); color:white; width:100%; border:none; padding:15px; border-radius:8px; cursor:pointer; font-weight:bold;">ç¢ºèªæˆè·ç™»è¨˜</button>
            </form>
        </div>
    </div>

    <!-- Config -->
    <div id="page-config" style="display:none;">
        <header><h1>çµ„ç¹”å‘½åè¨­å®š</h1></header>
        <div class="card">
            <div id="config-ui" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:15px;"></div>
            <button onclick="saveConfig()" style="margin-top:20px; background:var(--primary); color:white; padding:15px 30px; border:none; border-radius:8px;">å„²å­˜çµ„ç¹”å‘½å</button>
        </div>
    </div>
</div>

<div id="qr-overlay" onclick="this.style.display='none'">
    <div class="qr-card" onclick="event.stopPropagation()">
        <h3>å°ä¸­å—ç‘¤å®®è€å…­åª½æœƒ<br>æˆå“¡ç™»è¨˜ QR Code</h3>
        <div id="qrcode" style="margin:20px auto;"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    let members = JSON.parse(localStorage.getItem('nan-yao-v6-m')) || [];
    let config = JSON.parse(localStorage.getItem('nan-yao-v6-c')) || {};
    let isEditing = true;

    if (Object.keys(config).length === 0) {
        for(let i=1; i<=11; i++) {
            config[i] = { name: `ç¬¬ ${i} è§’`, sk: { 1:"1å°è§’", 2:"2å°è§’", 3:"3å°è§’", 4:"4å°è§’" } };
        }
    }

    function init() {
        const kSelect = document.getElementById('m-kaku');
        kSelect.innerHTML = '';
        for(let i in config) kSelect.innerHTML += `<option value="${i}">${config[i].name}</option>`;
        
        const cUI = document.getElementById('config-ui');
        cUI.innerHTML = '';
        for(let i in config) {
            cUI.innerHTML += `
            <div class="card" style="border-top:3px solid var(--secondary)">
                <label>å¤§è§’ ${i} åç¨±</label><input type="text" id="cfg-n-${i}" value="${config[i].name}">
                <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    ${Object.keys(config[i].sk).map(j => `<input type="text" id="cfg-s-${i}-${j}" value="${config[i].sk[j]}">`).join('')}
                </div>
            </div>`;
        }
        handleRoleUI(); render();
    }

    function handleRoleUI() {
        const role = document.getElementById('m-base').value;
        const skWrap = document.getElementById('sk-wrap');
        const locGroup = document.getElementById('loc-group');
        
        // ç†äº‹æ˜¯æ•´è§’çš„ï¼Œç›£äº‹æ˜¯å…¨æœƒçš„
        locGroup.style.display = (role === 'ç›£äº‹') ? 'none' : 'block';
        skWrap.style.display = (role === 'ç†äº‹' || role === 'ç›£äº‹') ? 'none' : 'block';
        updateSK();
    }

    function updateSK() {
        const skSelect = document.getElementById('m-skaku');
        const kIdx = document.getElementById('m-kaku').value;
        if(!kIdx || !config[kIdx]) return;
        skSelect.innerHTML = '';
        for(let j in config[kIdx].sk) skSelect.innerHTML += `<option value="${j}">${config[kIdx].sk[j]}</option>`;
    }

    function validateQualifications() {
        const base = document.getElementById('m-base').value;
        const title = document.getElementById('m-title').value;
        const tip = document.getElementById('error-tip');
        tip.style.display = 'none';

        if ((title === 'ç†äº‹é•·' || title === 'å‰¯ç†äº‹é•·') && base !== 'ç†äº‹') {
            tip.textContent = "âš ï¸ æé†’ï¼šæ ¹æ“šç« ç¨‹ï¼Œç†äº‹é•·èˆ‡å‰¯ç†äº‹é•·éœ€å…·å‚™ã€Œç†äº‹ã€èº«ä»½ã€‚";
            tip.style.display = 'block';
        }
        if (title === 'å¸¸å‹™ç›£äº‹' && base !== 'ç›£äº‹') {
            tip.textContent = "âš ï¸ æé†’ï¼šæ ¹æ“šç« ç¨‹ï¼Œå¸¸å‹™ç›£äº‹éœ€å…·å‚™ã€Œç›£äº‹ã€èº«ä»½ã€‚";
            tip.style.display = 'block';
        }
    }

    function render() {
        // Dashboard Stats
        const core = document.getElementById('core-stats');
        const chairperson = members.find(m => m.title === 'ç†äº‹é•·');
        const vChair = members.find(m => m.title === 'å‰¯ç†äº‹é•·');
        core.innerHTML = `
            <p>ç†äº‹é•·ï¼š${chairperson ? chairperson.name : '<span style="color:#ccc">é¸æ‹”ä¸­</span>'}</p>
            <p>å‰¯ç†äº‹é•·ï¼š${vChair ? vChair.name : '<span style="color:#ccc">é¸æ‹”ä¸­</span>'}</p>
        `;

        const sup = document.getElementById('sup-stats');
        const supervisors = members.filter(m => m.baseRole === 'ç›£äº‹');
        const execSup = members.find(m => m.title === 'å¸¸å‹™ç›£äº‹');
        sup.innerHTML = `
            <p>ç›£äº‹æ•¸ï¼š${supervisors.length} / 3 å</p>
            <p>å¸¸å‹™ç›£äº‹ï¼š${execSup ? execSup.name : '<span style="color:#ccc">é¸æ‹”ä¸­</span>'}</p>
        `;

        // Kaku Table
        const kBody = document.getElementById('kaku-list');
        kBody.innerHTML = '';
        for(let i in config) {
            const dir = members.find(m => m.kaku == i && m.baseRole === 'ç†äº‹');
            const boards = members.filter(m => m.kaku == i && m.baseRole === 'è‘£äº‹');
            const totalSK = Object.keys(config[i].sk).length;
            const progress = (boards.length / totalSK) * 100;
            kBody.innerHTML += `<tr>
                <td>${config[i].name}</td>
                <td>${dir ? dir.name : '--'}</td>
                <td>${boards.length} / ${totalSK} å</td>
                <td><div class="progress-bg"><div class="progress-fill" style="width:${progress}%"></div></div></td>
            </tr>`;
        }

        // Member List
        const mBody = document.getElementById('member-table');
        const search = document.getElementById('search-m').value.toLowerCase();
        mBody.innerHTML = '';
        members.filter(m => m.name.includes(search) || m.phone.includes(search)).forEach(m => {
            const loc = m.baseRole === 'ç›£äº‹' ? 'å…¨æœƒç›£äº‹æœƒ' : (m.baseRole === 'ç†äº‹' ? config[m.kaku].name : `${config[m.kaku].name} (${config[m.kaku].sk[m.skaku]})`);
            mBody.innerHTML += `<tr>
                <td><strong>${m.name}</strong></td>
                <td><span class="badge role-identity">${m.baseRole}</span></td>
                <td>${m.title ? '<span class="badge role-title">'+m.title+'</span>' : '--'}</td>
                <td>${loc}</td>
                <td class="admin-only"><button onclick="delM(${m.id})" style="color:red; background:none; border:none; cursor:pointer;">åˆªé™¤</button></td>
            </tr>`;
        });
    }

    function saveConfig() {
        for(let i in config) {
            config[i].name = document.getElementById(`cfg-n-${i}`).value;
            for(let j in config[i].sk) { config[i].sk[j] = document.getElementById(`cfg-s-${i}-${j}`).value; }
        }
        localStorage.setItem('nan-yao-v6-c', JSON.stringify(config));
        alert('çµ„ç¹”è¨­å®šå·²æˆåŠŸæ›´æ–°ï¼'); init();
    }

    function delM(id) { if(confirm('ç¢ºå®šè¦åˆªé™¤?')) { members = members.filter(m => m.id !== id); save(); render(); } }
    function save() { localStorage.setItem('nan-yao-v6-m', JSON.stringify(members)); }

    document.getElementById('add-form').onsubmit = function(e) {
        e.preventDefault();
        const base = document.getElementById('m-base').value;
        const title = document.getElementById('m-title').value;
        const kaku = document.getElementById('m-kaku').value;
        const skaku = document.getElementById('m-skaku').value;

        // Validations
        if (base === 'ç†äº‹' && members.find(m => m.kaku == kaku && m.baseRole === 'ç†äº‹')) return alert('è©²è§’å·²æœ‰ç†äº‹ï¼');
        if (base === 'è‘£äº‹' && members.find(m => m.kaku == kaku && m.skaku == skaku && m.baseRole === 'è‘£äº‹')) return alert('è©²å°è§’å·²æœ‰è‘£äº‹ï¼');
        if (base === 'ç›£äº‹' && members.filter(m => m.baseRole === 'ç›£äº‹').length >= 3) return alert('å…¨æœƒåƒ…é™ 3 åç›£äº‹ï¼');
        if (title === 'ç†äº‹é•·' && members.find(m => m.title === 'ç†äº‹é•·')) return alert('ç†äº‹é•·åƒ…é™ 1 åï¼');

        members.push({ id: Date.now(), name: document.getElementById('m-name').value, phone: document.getElementById('m-phone').value, baseRole: base, title: title, kaku: kaku, skaku: skaku });
        save(); alert('æˆè·æˆåŠŸï¼'); showPage('members');
    };

    function showPage(p) {
        document.querySelectorAll('#main > div').forEach(d => d.style.display='none');
        document.getElementById('page-'+p).style.display='block';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        render();
    }

    function toggleMode() {
        isEditing = !isEditing;
        document.body.className = isEditing ? 'admin-mode' : 'readonly-mode';
        document.getElementById('toggle-mode').textContent = isEditing ? 'ğŸ”“ åˆ‡æ›è‡³å”¯è®€æ¨¡å¼' : 'ğŸ”’ åˆ‡æ›è‡³ç®¡ç†æ¨¡å¼';
        showPage('dashboard');
    }

    function showQRCode() {
        const container = document.getElementById('qrcode');
        container.innerHTML = '';
        new QRCode(container, { text: window.location.href.split('?')[0] + "?page=add", width: 180, height: 180 });
        document.getElementById('qr-overlay').style.display = 'flex';
    }

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('page') === 'add') showPage('add');
        init();
    };
</script>
</body>
</html>
