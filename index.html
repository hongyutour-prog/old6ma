<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­å—ç‘¤å®®å¤©ä¸Šè–æ¯è€å…­åª½æœƒ - æœƒå“¡ç®¡ç†ç³»çµ±</title>
    <style>
        :root {
            --primary: #800000; --secondary: #daa520; --accent: #e67e22;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9; --light: #fdfaf5; --dark: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--light); color: var(--dark); display: flex; height: 100vh; }
        
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; border-right: 3px solid var(--secondary); position: relative; z-index: 100; }
        #sidebar h2 { font-size: 0.9rem; margin-bottom: 25px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; transition: 0.2s; display: flex; align-items: center; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--secondary); color: var(--primary); font-weight: bold; }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }

        #main { flex-grow: 1; padding: 30px; overflow-y: auto; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); font-size: 1.4rem; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; line-height: 1.8; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fdf5f5; color: var(--primary); font-size: 0.85rem; font-weight: bold; }
        
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 5px; display: inline-block; }
        .role-identity { background: #8e44ad; }
        .role-title { background: var(--secondary); color: var(--primary); border: 1px solid var(--primary); }
        
        .progress-bg { width: 100%; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--success); transition: 0.5s; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #fff; }
        
        .btn-action { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .payload-box { background: #1e1e1e; color: #4af626; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; margin-top: 15px; border: 1px solid #444; }

        #qr-overlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        .qr-card { background:white; padding:30px; border-radius:15px; text-align:center; box-shadow: 0 0 30px var(--secondary); }
        
        .mode-toggle-container { position:absolute; bottom: 20px; left: 15px; right: 15px; }
        .btn-mode { width:100%; padding:10px; border-radius:8px; border:1px solid var(--secondary); background:none; color:var(--secondary); cursor:pointer; font-weight:bold; font-size: 0.8rem; }
        .readonly-mode .admin-only { display: none !important; }

        @media (max-width: 768px) { #sidebar { display: none; } #main { padding: 15px; } }
    </style>
</head>
<body class="admin-mode">

<div id="sidebar">
    <h2>è€å…­åª½æœƒç®¡ç†ç³»çµ±</h2>
    <div class="nav-item active" onclick="showPage('history')"><span class="nav-icon">ğŸ“œ</span> æœƒå²æ²¿é©</div>
    <div class="nav-item" onclick="showPage('dashboard')"><span class="nav-icon">ğŸ“Š</span> çµ„ç¹”ç¸½è¦½</div>
    <div class="nav-item" onclick="showPage('members')"><span class="nav-icon">ğŸ‘¥</span> æˆå“¡åå†Š</div>
    <div class="nav-item admin-only" onclick="showPage('add')"><span class="nav-icon">â•</span> æˆå“¡ç™»è¨˜</div>
    <div class="nav-item admin-only" onclick="showPage('msg')"><span class="nav-icon">ğŸ“£</span> è¨Šæ¯ä¸­å¿ƒ</div>
    <div class="nav-item admin-only" onclick="showPage('config')"><span class="nav-icon">âš™ï¸</span> è§’ä½å‘½å</div>
    <div class="nav-item admin-only" onclick="showQRCode()"><span class="nav-icon">ğŸ“±</span> åˆ†äº«ç™»è¨˜ç¢¼</div>
    
    <div class="mode-toggle-container">
        <button id="toggle-mode" class="btn-mode" onclick="toggleMode()">ğŸ”“ ç›®å‰ï¼šç®¡ç†å“¡æ¨¡å¼</button>
    </div>
</div>

<div id="main">
    <!-- History Page -->
    <div id="page-history">
        <header><h1>æœƒå²æ²¿é©</h1></header>
        <div class="card">
            <h2 style="color:var(--primary); margin-bottom:15px;">å°ä¸­å—ç‘¤å®®å¤©ä¸Šè–æ¯è€å…­åª½æœƒ</h2>
            <p><strong>ä¸€ã€èµ·æºèˆ‡çµ„ç¹”ï¼š</strong><br>
            å½°åŒ–å—ç‘¤å®®ã€Œè€å…­åª½æœƒã€å‰µç«‹æ–¼æ¸…åŒæ²»å¹´é–“ï¼Œæ˜¯ç”±å°ä¸­åœ°å€ï¼ˆå¤§å¢©åœ°å€ï¼‰ä¿¡çœ¾æ‰€ç™¼èµ·çµ„æˆï¼Œç‚ºå—ç‘¤å®®è‘—åçš„ã€Œåæœƒåª½ã€çµ„ç¹”ä¹‹ä¸€ã€‚é•·æœŸä»¥ä¾†å®ˆè­·è‘—ä¸­å°ç£åœ°å€çš„å¹³å®‰ï¼Œå±•ç¾äº†åª½ç¥–ä¿¡ä»°èˆ‡åœ°æ–¹ç¤¾æœƒçš„ç·Šå¯†å‚³æ‰¿ã€‚</p>
            <p style="margin-top:15px;"><strong>äºŒã€ç²¾ç¥å‚³æ‰¿ï¼š</strong><br>
            æœ¬æœƒä»¥ã€Œå¤©ä¸Šè–æ¯ã€è€å…­åª½ç‚ºæ ¸å¿ƒä¿¡ä»°ï¼Œç§‰æŒè–æ¯åšæ„›æ…ˆæ„›ã€å®ˆè­·çœ¾ç”Ÿçš„ç²¾ç¥ï¼Œåœ˜çµ 11 å€‹è§’ä½çš„å»£å¤§ä¿¡çœ¾ã€‚é€éå®Œå–„çš„ã€Œè§’ã€å°è§’ã€é¸æ‹”åˆ¶åº¦ï¼Œå»ºç«‹èµ·åš´è¬¹ä¸”å…·å‚™æ°‘ä¸»ç²¾ç¥çš„çµ„ç¹”é‹ä½œæ¨¡å¼ã€‚</p>
            <p style="margin-top:15px;"><strong>ä¸‰ã€çµ„ç¹”é¸æ‹”é‚è¼¯ï¼š</strong><br>
            æœ¬æœƒé‹ä½œä¾å¾ªä»¥ä¸‹é¸æ‹”ç¨‹åºï¼š
            <ul style="margin-left:25px; margin-top:10px;">
                <li><strong>è‘£äº‹</strong>ï¼šç”±å„å°è§’æˆå“¡ä¸­é¸æ‹”ç”¢ç”Ÿï¼ˆæ¯å°è§’ æ•¸ åï¼‰ã€‚</li>
                <li><strong>ç†äº‹</strong>ï¼šç”±å„è§’è‘£äº‹äº’é¸ç”¢ç”Ÿï¼ˆæ¯å¤§è§’ 1ã€2 åï¼Œå…¨æœƒå…± 12 åï¼‰ã€‚</li>
                <li><strong>æ±ºç­–å±¤</strong>ï¼šç”± 11 åç†äº‹äº’é¸å‡ºç†äº‹é•·ã€å‰¯ç†äº‹é•·åŠ 3 åç›£äº‹ã€‚</li>
                <li><strong>å¸¸å‹™ç›£äº‹</strong>ï¼šç”± 3 åç›£äº‹äº’é¸å‡º 1 åã€‚</li>
                <li><strong>æœƒå‹™åœ˜éšŠ</strong>ï¼šå¦è˜ç¸½å¹¹äº‹ã€å¹¹äº‹ã€ç§˜æ›¸ã€æœƒè¨ˆç­‰ï¼Œå”åŠ©æ¨å‹•æœƒå‹™ã€‚</li>
            </ul>
            </p>
            <p style="margin-top:15px;"><strong>å››ã€æ•¸ä½å±•æœ›ï¼š</strong><br>
            æœ¬ç³»çµ±ä¹‹å»ºç«‹ï¼Œè±¡å¾µè€å…­åª½æœƒé‚å‘æ•¸ä½åŒ–ç®¡ç†çš„æ–°é‡Œç¨‹ã€‚é€éç¾ä»£ç§‘æŠ€è¨˜éŒ„æˆå“¡è³‡æ–™èˆ‡æºé€šï¼Œè®“æœƒå‹™é‹ä½œæ›´é€æ˜ã€å‚³æ‰¿æ›´é•·ä¹…ã€‚é¡˜åª½ç¥–åº‡ä½‘æˆ‘æœƒï¼Œé¦™ç«è¬å¹´ã€‚</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="page-dashboard" style="display:none;">
        <header><h1>çµ„ç¹”æ¶æ§‹ç¸½è¦½</h1></header>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div class="card" style="border-left: 5px solid var(--secondary);">
                <h3>æ ¸å¿ƒé ˜å°éšå±¤</h3>
                <div id="leader-info" style="margin-top:10px;"></div>
            </div>
            <div class="card" style="border-left: 5px solid var(--info);">
                <h3>ç›£äº‹æœƒç¾æ³</h3>
                <div id="supervisor-info" style="margin-top:10px;"></div>
            </div>
        </div>
        <div class="card">
            <h3>11 è§’çµ„ç¹”ä½ˆå»ºé€²åº¦</h3>
            <table style="margin-top:15px;">
                <thead><tr><th>è§’ä½</th><th>ç†äº‹ (1)</th><th>è‘£äº‹é€²åº¦</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="kaku-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Member List -->
    <div id="page-members" style="display:none;">
        <header><h1>æˆå“¡åå†Š</h1><input type="text" id="search-m" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€è·å‹™..." oninput="render()" style="width:250px;"></header>
        <div class="card">
            <table>
                <thead><tr><th>å§“å</th><th>èº«ä»½</th><th>è·å‹™</th><th>æ‰‹æ©Ÿ</th><th>æ­¸å±¬è§’ä½</th><th class="admin-only">ç®¡ç†</th></tr></thead>
                <tbody id="member-table"></tbody>
            </table>
        </div>
    </div>

    <!-- Message Center -->
    <div id="page-msg" style="display:none;">
        <header><h1>ğŸ“£ è¨Šæ¯ç™¼é€ä¸­å¿ƒ</h1></header>
        <div class="card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="form-group"><label>ç›®æ¨™è·ç´š</label><select id="msg-role"><option value="all">å…¨é«”</option><option value="ç†äº‹">å…¨é«”ç†äº‹</option><option value="è‘£äº‹">å…¨é«”è‘£äº‹</option><option value="çµ„é•·">å…¨é«”çµ„é•·</option><option value="ç›£äº‹">å…¨é«”ç›£äº‹</option></select></div>
                <div class="form-group"><label>ç›®æ¨™è§’ä½</label><select id="msg-kaku"></select></div>
            </div>
            <div class="form-group"><label>è¨Šæ¯å…§å®¹</label><textarea id="msg-body" rows="4"></textarea></div>
            <button class="btn-action" onclick="genMsg()">ç”¢ç”ŸæŒ‡ä»¤</button>
            <div id="payload-area" style="display:none;"><div class="payload-box" id="payload-content"></div><button onclick="copyMsg()">è¤‡è£½æŒ‡ä»¤</button></div>
        </div>
    </div>

    <!-- Add Member -->
    <div id="page-add" style="display:none;">
        <header><h1>æ–°æˆå“¡ç™»è¨˜</h1></header>
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <form id="add-form">
                <div class="form-group"><label>å§“å</label><input type="text" id="in-name" required></div>
                <div class="form-group"><label>æ‰‹æ©Ÿ</label><input type="tel" id="in-phone" required></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><label>èº«ä»½</label><select id="in-base" onchange="uiAdd()"><option value="æœƒå“¡">æœƒå“¡</option><option value="çµ„é•·">çµ„é•·</option><option value="è‘£äº‹">è‘£äº‹</option><option value="ç†äº‹">ç†äº‹</option><option value="ç›£äº‹">ç›£äº‹</option></select></div>
                    <div class="form-group"><label>å…¼ä»»è·å‹™</label><select id="in-title"><option value="">--</option><option value="ç†äº‹é•·">ç†äº‹é•·</option><option value="å‰¯ç†äº‹é•·">å‰¯ç†äº‹é•·</option><option value="å¸¸å‹™ç›£äº‹">å¸¸å‹™ç›£äº‹</option><option value="ç¸½å¹¹äº‹">ç¸½å¹¹äº‹</option><option value="æœƒè¨ˆ">æœƒè¨ˆ</option><option value="ç§˜æ›¸">ç§˜æ›¸</option></select></div>
                </div>
                <div id="kaku-sect">
                    <div class="form-group"><label>å¤§è§’</label><select id="in-kaku" onchange="uiSK()"></select></div>
                    <div class="form-group" id="sk-wrap"><label>å°è§’</label><select id="in-skaku"></select></div>
                </div>
                <button type="submit" class="btn-action" style="width:100%">ç¢ºèªç™»è¨˜</button>
            </form>
        </div>
    </div>

    <!-- Config -->
    <div id="page-config" style="display:none;">
        <header><h1>è§’ä½å‘½åè¨­å®š</h1></header>
        <div id="cfg-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:15px;"></div>
        <button class="btn-action" onclick="saveCfg()" style="margin-top:20px;">å„²å­˜è¨­å®š</button>
    </div>
</div>

<div id="qr-overlay" onclick="this.style.display='none'">
    <div class="qr-card" onclick="event.stopPropagation()"><h3>ç™»è¨˜ QR Code</h3><div id="qrcode" style="margin:20px auto;"></div></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    let members = JSON.parse(localStorage.getItem('lym_final_m')) || [];
    let config = JSON.parse(localStorage.getItem('lym_final_c')) || {};
    let isAdmin = true;

    if (Object.keys(config).length === 0) {
        for(let i=1; i<=11; i++) config[i] = { name: `ç¬¬ ${i} è§’`, sk: { 1:"1å°è§’", 2:"2å°è§’", 3:"3å°è§’", 4:"4å°è§’" } };
    }

    function init() {
        const kSelect = document.getElementById('in-kaku');
        const mkSelect = document.getElementById('msg-kaku');
        kSelect.innerHTML = ''; mkSelect.innerHTML = '<option value="all">å…¨æœƒ</option>';
        for(let i in config) { 
            let opt = `<option value="${i}">${config[i].name}</option>`;
            kSelect.innerHTML += opt; mkSelect.innerHTML += opt;
        }
        const grid = document.getElementById('cfg-grid'); grid.innerHTML = '';
        for(let i in config) {
            grid.innerHTML += `<div class="card" style="border-top:3px solid var(--secondary)">
                <label>å¤§è§’ ${i}</label><input type="text" id="cn-${i}" value="${config[i].name}">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
                    ${Object.keys(config[i].sk).map(j => `<input type="text" id="cs-${i}-${j}" value="${config[i].sk[j]}">`).join('')}
                </div></div>`;
        }
        uiAdd(); render();
    }

    function uiAdd() {
        const r = document.getElementById('in-base').value;
        document.getElementById('kaku-sect').style.display = (r==='ç›£äº‹') ? 'none' : 'block';
        document.getElementById('sk-wrap').style.display = (r==='ç†äº‹'||r==='ç›£äº‹') ? 'none' : 'block';
        uiSK();
    }
    function uiSK() {
        const s = document.getElementById('in-skaku'); const k = document.getElementById('in-kaku').value;
        s.innerHTML = ''; for(let j in config[k].sk) s.innerHTML += `<option value="${j}">${config[k].sk[j]}</option>`;
    }

    function showPage(p) {
        document.querySelectorAll('#main > div').forEach(d => d.style.display='none');
        document.getElementById('page-'+p).style.display='block';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const map = { history:0, dashboard:1, members:2, add:3, msg:4, config:5 };
        if(map[p] !== undefined) document.querySelectorAll('.nav-item')[map[p]].classList.add('active');
        render();
    }

    function toggleMode() {
        isAdmin = !isAdmin; document.body.className = isAdmin ? 'admin-mode' : 'readonly-mode';
        document.getElementById('toggle-mode').textContent = isAdmin ? 'ğŸ”“ ç›®å‰ï¼šç®¡ç†å“¡æ¨¡å¼' : 'ğŸ”’ ç›®å‰ï¼šå”¯è®€æ¨¡å¼';
        if(!isAdmin) showPage('history');
    }

    function render() {
        document.getElementById('leader-info').innerHTML = `ç†äº‹é•·ï¼š${(members.find(m=>m.title==='ç†äº‹é•·')||{}).name||'--'}<br>å‰¯ç†äº‹é•·ï¼š${(members.find(m=>m.title==='å‰¯ç†äº‹é•·')||{}).name||'--'}`;
        document.getElementById('supervisor-info').innerHTML = `ç›£äº‹æ•¸ï¼š${members.filter(m=>m.baseRole==='ç›£äº‹').length} / 3<br>å¸¸å‹™ç›£äº‹ï¼š${(members.find(m=>m.title==='å¸¸å‹™ç›£äº‹')||{}).name||'--'}`;
        
        const kBody = document.getElementById('kaku-list'); kBody.innerHTML = '';
        for(let i in config) {
            const d = members.find(m=>m.kaku==i && m.baseRole==='ç†äº‹');
            const b = members.filter(m=>m.kaku==i && m.baseRole==='è‘£äº‹');
            const total = Object.keys(config[i].sk).length;
            kBody.innerHTML += `<tr><td>${config[i].name}</td><td>${d?d.name:'--'}</td><td>${b.length}/${total}å“¡</td><td><div class="progress-bg"><div class="progress-fill" style="width:${(b.length/total)*100}%"></div></div></td></tr>`;
        }

        const mBody = document.getElementById('member-table'); const s = document.getElementById('search-m').value.toLowerCase();
        mBody.innerHTML = '';
        members.filter(m=>m.name.includes(s)||m.phone.includes(s)).forEach(m => {
            const loc = m.baseRole==='ç›£äº‹' ? 'ç›£äº‹æœƒ' : (m.baseRole==='ç†äº‹' ? config[m.kaku].name : `${config[m.kaku].name}(${config[m.kaku].sk[m.skaku]})`);
            mBody.innerHTML += `<tr><td>${m.name}</td><td><span class="badge role-identity">${m.baseRole}</span></td><td>${m.title?'<span class="badge role-title">'+m.title+'</span>':'--'}</td><td>${m.phone}</td><td>${loc}</td><td class="admin-only"><button onclick="delM(${m.id})" style="color:red">åˆªé™¤</button></td></tr>`;
        });
    }

    function saveCfg() {
        for(let i in config) {
            config[i].name = document.getElementById('cn-'+i).value;
            for(let j in config[i].sk) config[i].sk[j] = document.getElementById(`cs-${i}-${j}`).value;
        }
        localStorage.setItem('lym_final_c', JSON.stringify(config)); alert('æ›´æ–°æˆåŠŸï¼'); init();
    }

    function delM(id) { if(confirm('åˆªé™¤?')) { members = members.filter(m=>m.id!==id); localStorage.setItem('lym_final_m', JSON.stringify(members)); render(); } }

    document.getElementById('add-form').onsubmit = function(e) {
        e.preventDefault();
        members.push({ id:Date.now(), name:document.getElementById('in-name').value, phone:document.getElementById('in-phone').value, baseRole:document.getElementById('in-base').value, title:document.getElementById('in-title').value, kaku:document.getElementById('in-kaku').value, skaku:document.getElementById('in-skaku').value });
        localStorage.setItem('lym_final_m', JSON.stringify(members)); alert('ç™»è¨˜æˆåŠŸï¼'); showPage('members');
    };

    function showQRCode() {
        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById('qrcode'), { text: window.location.href.split('?')[0] + "?page=add", width: 180, height: 180 });
        document.getElementById('qr-overlay').style.display='flex';
    }

    window.onload = () => { if(new URLSearchParams(window.location.search).get('page')==='add') showPage('add'); init(); };
</script>
</body>
</html>