<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è€å…­åª½æœƒç®¡ç†ç³»çµ± V17.4</title>
    <style>
        :root {
            --primary: #800000; --secondary: #daa520; --light: #fdfaf5;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9; --dark: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--light); color: var(--dark); display: flex; height: 100vh; overflow: hidden; }
        
        /* é›»è…¦ç‰ˆå´é‚Šæ¬„ */
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; border-right: 3px solid var(--secondary); overflow-y: auto; transition: 0.3s; }
        #sidebar h2 { font-size: 0.95rem; margin-bottom: 25px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .nav-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; font-size: 1rem; color: #eee; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--secondary); color: var(--primary); font-weight: bold; }

        #main { flex-grow: 1; padding: 30px; overflow-y: auto; width: 100%; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); font-size: 1.4rem; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        
        /* æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ• */
        #mobile-menu-btn { 
            display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; 
            background: var(--primary); color: var(--secondary); border: 2px solid var(--secondary);
            padding: 8px 15px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– */
        @media (max-width: 800px) {
            body { flex-direction: column; }
            #mobile-menu-btn { display: block; } /* é¡¯ç¤ºé¸å–®æŒ‰éˆ• */
            #sidebar { 
                position: fixed; left: -260px; top: 0; height: 100%; z-index: 1000; 
                width: 260px; box-shadow: 5px 0 15px rgba(0,0,0,0.3); 
            }
            #sidebar.open { left: 0; }
            #main { padding: 70px 15px 15px 15px; } /* ç•™ç©ºé–“çµ¦é ‚éƒ¨æŒ‰éˆ• */
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .form-row { display: block !important; }
        }

        /* æƒæç™»è¨˜æ¨¡å¼ (éš±è—æ‰€æœ‰å°èˆª) */
        body.mobile-reg-mode #sidebar, body.mobile-reg-mode #mobile-menu-btn { display: none !important; }
        body.mobile-reg-mode #main { padding: 15px !important; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .form-group input, .form-group select { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; width: 100%; cursor: pointer; }

        #sync-status { position: fixed; bottom: 5px; right: 5px; font-size: 0.6rem; color: #ccc; }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
    </style>
</head>
<body>

<button id="mobile-menu-btn" onclick="toggleSidebar()">â˜° é¸å–®</button>
<div id="menu-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
    <h2 style="margin-top:20px;">è€å…­åª½æœƒç®¡ç†ç³»çµ± V17.4</h2>
    <div class="nav-item active" onclick="navTo('history')">ğŸ“œ æœƒå²æ²¿é©</div>
    <div class="nav-item" onclick="navTo('dashboard')">ğŸ“Š çµ„ç¹”ä½ˆå»ºç¸½è¦½</div>
    <div class="nav-item" onclick="navTo('members')">ğŸ‘¥ å…¨æœƒåå†Š</div>
    <div class="nav-item admin-only" onclick="navTo('add')">â• æˆå“¡ç™»è¨˜æˆè·</div>
    <div class="nav-item admin-only" onclick="navTo('config')">âš™ï¸ é›²ç«¯æ¶æ§‹è¨­å®š</div>
    <div class="nav-item admin-only" onclick="showQRCode()">ğŸ“± åˆ†äº«ç™»è¨˜ç¢¼</div>
    <div style="padding: 20px 10px;">
        <button onclick="toggleMode()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--secondary); background:none; color:var(--secondary); font-size:0.8rem; font-weight:bold;">ç®¡ç†å“¡æ¨¡å¼åˆ‡æ›</button>
    </div>
</div>

<div id="main">
    <!-- æœƒå²æ²¿é© -->
    <div id="page-history">
        <header><h1>æœƒå²æ²¿é©</h1> <button class="btn-action admin-only" onclick="editHistory()" style="width:auto; padding:10px 15px;">ğŸ“ ç·¨è¼¯</button></header>
        <div class="card" id="history-display">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:15px;">ã€è€å…­åª½æœƒæ²¿é©ã€‘</h2>
            <div id="history-text">è¼‰å…¥ä¸­...</div>
            <p style="margin-top:20px; text-align:right; font-weight:bold; color:var(--primary);">ç†äº‹é•·ï¼šç›§å®šåœ‹<br>å‰¯ç†äº‹é•·ï¼šæéŠ˜é‘«<br>ç¸½å¹¹äº‹ï¼šé»ƒéˆä¸ã€€æ­éŒ„</p>
        </div>
        <div id="history-editor" class="card" style="display:none;"><textarea id="history-input" style="height:300px; width:100%; margin-bottom:15px; padding:10px; font-size:1rem;"></textarea><button class="btn-action" onclick="saveHistory()">ğŸ’¾ å„²å­˜</button></div>
    </div>

    <!-- æˆå“¡ç™»è¨˜ (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ) -->
    <div id="page-add" style="display:none;">
        <header><h1>æˆå“¡ç™»è¨˜æˆè·</h1></header>
        <div id="add-success-screen" style="display:none; text-align:center; padding:30px 10px;"><div style="font-size: 5rem;">âœ…</div><h2 style="margin:20px 0; color:var(--success);">ç™»è¨˜å®Œæˆ</h2><button class="btn-action" onclick="location.reload()">ç¹¼çºŒç™»è¨˜ä¸‹ä¸€ä½</button></div>
        <div id="add-form-container" class="card">
            <form id="add-form">
                <div class="form-group"><label>å§“å</label><input type="text" id="in-name" placeholder="è«‹è¼¸å…¥å§“å" required></div>
                <div class="form-group"><label>æ‰‹æ©Ÿ</label><input type="tel" id="in-phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required></div>
                <div class="form-group"><label>èº«ä»½</label><select id="in-base" onchange="uiAdd()"><option value="æœƒå“¡">æœƒå“¡</option><option value="çµ„é•·">çµ„é•·</option><option value="è‘£äº‹">è‘£äº‹</option><option value="ç†äº‹">ç†äº‹</option><option value="ç›£äº‹">ç›£äº‹</option></select></div>
                <div id="kaku-sect">
                    <div class="form-group"><label>å¤§è§’</label><select id="in-kaku" onchange="uiSK()"></select></div>
                    <div class="form-group" id="sk-wrap"><label>å°è§’</label><select id="in-skaku"></select></div>
                </div>
                <button type="submit" class="btn-action">âœ… ç¢ºèªå„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- å…¶é¤˜é é¢ (ç•¥) -->
    <div id="page-dashboard" style="display:none;"><header><h1>ä½ˆå»ºé€²åº¦</h1></header><div id="leader-info" class="card">ç†äº‹é•·ï¼šç›§å®šåœ‹<br>å‰¯ç†äº‹é•·ï¼šæéŠ˜é‘«</div><div class="card"><table><thead><tr><th>è§’ä½</th><th>ç†äº‹</th><th>è‘£äº‹</th></tr></thead><tbody id="kaku-list"></tbody></table></div></div>
    <div id="page-members" style="display:none;"><header><h1>å…¨æœƒåå†Š</h1><input type="text" id="search-m" placeholder="æœå°‹..." oninput="render()" style="padding:10px; width:100%; margin-top:10px;"></header><div class="card"><table style="font-size:0.9rem;"><thead><tr><th>å§“å</th><th>æ­¸å±¬</th><th class="admin-only"></th></tr></thead><tbody id="member-table"></tbody></table></div></div>
    <div id="page-config" style="display:none;"><header><h1>æ¶æ§‹è¨­å®š</h1></header><div id="cfg-grid"></div><button class="btn-action" onclick="saveCfg()" style="margin-top:20px;">å„²å­˜åŒæ­¥é›²ç«¯</button></div>
</div>

<div id="sync-status">é›²ç«¯ï¼šå°±ç·’</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzfLug-EeJk-lOxMtR0YwCPqO-FCppV3aqehychOjUsY4MbVzEVCIv62CPz1iFScX4/exec";
    let members = []; let config = {}; let historyContent = ""; let isAdmin = true;
    const kPresets = { 1: { sk: 2, d: 1 }, 2: { sk: 5, d: 2 }, 3: { sk: 4, d: 1 }, 4: { sk: 2, d: 1 }, 5: { sk: 3, d: 1 }, 6: { sk: 3, d: 1 }, 7: { sk: 3, d: 1 }, 8: { sk: 3, d: 1 }, 9: { sk: 2, d: 1 }, 10: { sk: 3, d: 1 }, 11: { sk: 3, d: 1 } };

    async function syncFromCloud() {
        document.getElementById('sync-status').textContent = "åŒæ­¥ä¸­...";
        try {
            const res = await fetch(GAS_URL); const data = await res.json();
            if(data.config) config = JSON.parse(data.config);
            if(data.members) members = JSON.parse(data.members);
            if(data.history) { try { historyContent = JSON.parse(data.history); } catch(e) { historyContent = data.history; } }
            if (Object.keys(config).length === 0) {
                for(let i=1; i<=11; i++) {
                    let skMap = {}; for(let j=1; j<=kPresets[i].sk; j++) skMap[j] = `${j}å°è§’`;
                    config[i] = { name: `ç¬¬ ${i} è§’`, skCount: kPresets[i].sk, dQuota: kPresets[i].d, sk: skMap };
                }
            }
            init(); document.getElementById('sync-status').textContent = "åŒæ­¥å®Œæˆ";
        } catch (e) { document.getElementById('sync-status').textContent = "é€£ç·šå¤±æ•—"; init(); }
    }

    function init() {
        document.getElementById('history-text').innerText = historyContent;
        const kSelect = document.getElementById('in-kaku'); kSelect.innerHTML = '';
        for(let i in config) kSelect.innerHTML += `<option value="${i}">${config[i].name}</option>`;
        const grid = document.getElementById('cfg-grid'); grid.innerHTML = '';
        for(let i in config) {
            let sks = ''; for(let j=1; j<=config[i].skCount; j++) sks += `<input type="text" id="cs-${i}-${j}" value="${config[i].sk[j]||j+'å°è§’'}" style="margin-top:5px; padding:10px; width:100%;">`;
            grid.innerHTML += `<div class="card"><strong>${config[i].name}</strong><div style="display:flex;flex-direction:column;">${sks}</div></div>`;
        }
        uiAdd(); render();
    }

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const overlay = document.getElementById('menu-overlay');
        sb.classList.toggle('open');
        overlay.style.display = sb.classList.contains('open') ? 'block' : 'none';
    }

    function navTo(page) {
        showPage(page);
        if (window.innerWidth <= 800) toggleSidebar(); // æ‰‹æ©Ÿç‰ˆè·³è½‰å¾Œè‡ªå‹•æ”¶èµ·é¸å–®
    }

    function showPage(p) {
        document.querySelectorAll('#main > div').forEach(d => d.style.display='none');
        document.getElementById('page-'+p).style.display='block';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        // ç°¡æ˜“æ¨™è¨˜ active
        const navItems = document.querySelectorAll('.nav-item');
        const map = { history:0, dashboard:1, members:2, add:3, config:4 };
        if(map[p]!==undefined) navItems[map[p]].classList.add('active');
    }

    function render() {
        const kBody = document.getElementById('kaku-list'); kBody.innerHTML = '';
        for(let i in config) {
            const dCount = members.filter(m=>m.kaku==i && m.baseRole==='ç†äº‹').length;
            const bCount = members.filter(m=>m.kaku==i && m.baseRole==='è‘£äº‹').length;
            kBody.innerHTML += `<tr><td>${config[i].name}</td><td>${dCount}/${config[i].dQuota}</td><td>${bCount}/${config[i].skCount}</td></tr>`;
        }
        const mBody = document.getElementById('member-table'); const s = document.getElementById('search-m').value.toLowerCase();
        mBody.innerHTML = '';
        members.filter(m=>m.name.includes(s)).forEach(m => {
            const loc = m.baseRole==='ç›£äº‹' ? 'ç›£äº‹æœƒ' : config[m.kaku].name;
            mBody.innerHTML += `<tr><td>${m.name}</td><td>${loc}</td><td class="admin-only"><button onclick="delM(${m.id})">âŒ</button></td></tr>`;
        });
    }

    async function saveToCloud(type, data) {
        await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: type, data: JSON.stringify(data) }) });
    }

    document.getElementById('add-form').onsubmit = async function(e) {
        e.preventDefault();
        members.push({ id:Date.now(), name:document.getElementById('in-name').value, phone:document.getElementById('in-phone').value, baseRole:document.getElementById('in-base').value, title:"", kaku:document.getElementById('in-kaku').value, skaku:document.getElementById('in-skaku').value });
        await saveToCloud("Members", members);
        document.getElementById('add-form-container').style.display = 'none';
        document.getElementById('add-success-screen').style.display = 'block';
    };

    function uiAdd() {
        const r = document.getElementById('in-base').value;
        document.getElementById('kaku-sect').style.display = (r==='ç›£äº‹') ? 'none' : 'block';
        document.getElementById('sk-wrap').style.display = (r==='ç†äº‹'||r==='ç›£äº‹') ? 'none' : 'block';
        uiSK();
    }
    function uiSK() {
        const s = document.getElementById('in-skaku'); const k = document.getElementById('in-kaku').value;
        if(!config[k]) return; s.innerHTML = ''; for(let j in config[k].sk) s.innerHTML += `<option value="${j}">${config[k].sk[j]}</option>`;
    }

    function toggleMode() {
        isAdmin = !isAdmin;
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'inline-block' : 'none');
        alert(isAdmin ? "å·²åˆ‡æ›è‡³ç®¡ç†å“¡æ¨¡å¼" : "å·²åˆ‡æ›è‡³ç€è¦½æ¨¡å¼");
    }

    window.onload = () => { 
        const params = new URLSearchParams(window.location.search);
        if(params.get('page') === 'add') {
            document.body.classList.add('mobile-reg-mode');
            showPage('add');
        } else {
            showPage('history');
        }
        syncFromCloud(); 
    };
</script>
</body>
</html>
